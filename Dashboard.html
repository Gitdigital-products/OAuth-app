<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Authenticating... | GitDigital</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="auth-status" style="text-align: center; margin-top: 20%;">
        <h2>üîÑ Finalizing GitDigital Connection...</h2>
        <p>Please do not close this window.</p>
    </div>

    <script>
        async function handleAuthCallback() {
            // 1. Extract the 'code' and 'state' from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            // 2. Security Check: Verify code exists
            if (!code) {
                document.getElementById('auth-status').innerHTML = "<h2>‚ùå Auth Failed</h2><p>No code found. Redirecting home...</p>";
                setTimeout(() => window.location.href = "/", 3000);
                return;
            }

            try {
                // 3. Exchange the code for a Token
                // NOTE: You'll need a backend worker/serverless function here
                // Because Client Secrets cannot be stored in frontend JS!
                const response = await fetch('https://your-api-worker.workers.dev/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, state })
                });

                const data = await response.json();

                if (data.token) {
                    // 4. Save the session (Securely)
                    sessionStorage.setItem('gitdigital_access_token', data.token);
                    
                    // 5. Success! Send them to the product dashboard
                    window.location.href = "/dashboard";
                } else {
                    throw new Error("Invalid token response");
                }
            } catch (err) {
                console.error("Auth Error:", err);
                document.getElementById('auth-status').innerHTML = "<h2>‚ö†Ô∏è Error</h2><p>Authentication failed. Please try again.</p>";
            }
        }

        // Run the function on page load
        handleAuthCallback();
    </script>
</body>
</html>

